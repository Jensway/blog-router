import tkinter as tk
import customtkinter as ctk  # éœ€è¦ pip install customtkinter
from tkinter import filedialog, messagebox
import subprocess
import threading
import os
import shutil
import json
from pathlib import Path
from datetime import datetime

# è®¾ç½®ä¸»é¢˜
ctk.set_appearance_mode("System")  # System, Dark, Light
ctk.set_default_color_theme("blue")

CONFIG_FILE = "deploy_config.json"


class ModernDeployTool(ctk.CTk):
    def __init__(self):
        super().__init__()

        self.title("MT-6000 ShareCenter éƒ¨ç½²å·¥å…· v3.0")
        self.geometry("1100x750")

        # å¸ƒå±€é…ç½®
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)

        # å˜é‡åˆå§‹åŒ–
        self.init_variables()
        self.load_config()

        # --- UI ç»„ä»¶ ---
        self.create_sidebar()
        self.create_main_view()
        self.create_log_area()

    def init_variables(self):
        self.go_file_path = tk.StringVar()
        self.output_file_name = tk.StringVar()
        self.publish_path = tk.StringVar()
        self.deploy_path = tk.StringVar(value="Y:\\RouterApp\\ShareCenter")
        self.ssh_host = tk.StringVar(value="192.168.8.1")
        self.ssh_port = tk.StringVar(value="22")
        self.ssh_user = tk.StringVar(value="root")
        self.ssh_password = tk.StringVar()
        self.remote_dir = tk.StringVar(value="/tmp/mountd/disk1_part1/RouterApp/ShareCenter")
        self.service_port = tk.StringVar(value="5000")
        self.auto_backup = tk.BooleanVar(value=True)

    def create_sidebar(self):
        """ä¾§è¾¹æ  - æ”¾ç½®è®¾ç½®å’Œå…¨å±€æ“ä½œ"""
        self.sidebar = ctk.CTkFrame(self, width=240, corner_radius=0)
        self.sidebar.grid(row=0, column=0, rowspan=2, sticky="nsew")

        ctk.CTkLabel(self.sidebar, text="âš™ï¸ éƒ¨ç½²é…ç½®", font=ctk.CTkFont(size=20, weight="bold")).pack(pady=20)

        # SSH è®¾ç½®ç»„
        ssh_group = ctk.CTkFrame(self.sidebar, fg_color="transparent")
        ssh_group.pack(fill="x", padx=20)

        self.add_side_entry(ssh_group, "ä¸»æœºIP", self.ssh_host)
        self.add_side_entry(ssh_group, "SSHå¯†ç ", self.ssh_password, show="*")
        self.add_side_entry(ssh_group, "è¿œç¨‹ç›®å½•", self.remote_dir)

        # é€‰é¡¹
        ctk.CTkCheckBox(self.sidebar, text="è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶", variable=self.auto_backup).pack(pady=10)

        # åº•éƒ¨æŒ‰é’®
        ctk.CTkButton(self.sidebar, text="ğŸ’¾ ä¿å­˜å…¨å±€é…ç½®", command=self.save_config).pack(side="bottom", pady=20,
                                                                                          padx=20)
        ctk.CTkButton(self.sidebar, text="ğŸ”„ æ¸…é™¤æ—¥å¿—", fg_color="gray", command=self.clear_log).pack(side="bottom",
                                                                                                     pady=10, padx=20)

    def add_side_entry(self, parent, label, var, **kwargs):
        ctk.CTkLabel(parent, text=label, font=ctk.CTkFont(size=12)).pack(anchor="w", pady=(10, 0))
        ctk.CTkEntry(parent, textvariable=var, height=30, **kwargs).pack(fill="x")

    def create_main_view(self):
        """ä¸»å·¥ä½œåŒº - æµç¨‹åŒ–æ“ä½œ"""
        self.main_frame = ctk.CTkScrollableFrame(self, fg_color="transparent")
        self.main_frame.grid(row=0, column=1, sticky="nsew", padx=20, pady=10)

        # --- ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘ ---
        self.create_step_card(
            self.main_frame, "Step 1: äº¤å‰ç¼–è¯‘",
            "é€‰æ‹© Go æºæ–‡ä»¶å¹¶ç¼–è¯‘ä¸º ARM64 æ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶",
            [
                ("é€‰æ‹©æ–‡ä»¶", self.browse_go_file, "blue"),
                ("å¼€å§‹ç¼–è¯‘", self.start_compile, "green")
            ],
            self.go_file_path, "æºæ–‡ä»¶è·¯å¾„..."
        )

        # --- ç¬¬äºŒæ­¥ï¼šéƒ¨ç½² ---
        self.create_step_card(
            self.main_frame, "Step 2: æœ¬åœ°åˆ†å‘",
            "å°†ç¼–è¯‘äº§ç‰©ç§»åŠ¨è‡³è·¯ç”±å™¨æ˜ å°„çš„ç½‘ç»œé©±åŠ¨å™¨ (WebDAV/SMB)",
            [
                ("é€‰æ‹©éƒ¨ç½²ç›®å½•", self.browse_deploy_path, "blue"),
                ("æ‰§è¡Œéƒ¨ç½²", self.local_deploy, "indigo")
            ],
            self.deploy_path, "éƒ¨ç½²è·¯å¾„..."
        )

        # --- ç¬¬ä¸‰æ­¥ï¼šè¿œç¨‹æ§åˆ¶ ---
        ssh_card = ctk.CTkFrame(self.main_frame)
        ssh_card.pack(fill="x", pady=10)

        ctk.CTkLabel(ssh_card, text="Step 3: è¿œç¨‹æœåŠ¡æ§åˆ¶", font=ctk.CTkFont(size=16, weight="bold")).grid(row=0,
                                                                                                           column=0,
                                                                                                           padx=15,
                                                                                                           pady=10,
                                                                                                           sticky="w")

        btn_box = ctk.CTkFrame(ssh_card, fg_color="transparent")
        btn_box.grid(row=1, column=0, padx=10, pady=10, sticky="ew")

        ctk.CTkButton(btn_box, text="â–¶ å¯åŠ¨", width=100, command=self.start_service).pack(side="left", padx=5)
        ctk.CTkButton(btn_box, text="â¹ åœæ­¢", width=100, fg_color="#E74C3C", command=self.stop_service).pack(
            side="left", padx=5)
        ctk.CTkButton(btn_box, text="ğŸ”„ é‡å¯", width=100, command=self.restart_service).pack(side="left", padx=5)
        ctk.CTkButton(btn_box, text="ğŸ” çŠ¶æ€", width=100, fg_color="gray", command=self.check_status).pack(side="left",
                                                                                                          padx=5)

        # ä¸€é”®æ“ä½œ
        ctk.CTkButton(self.main_frame, text="âš¡ ä¸€é”®å…¨æµç¨‹ï¼šç¼–è¯‘ + éƒ¨ç½² + é‡å¯",
                      height=50, font=ctk.CTkFont(size=15, weight="bold"),
                      command=self.one_click_all).pack(fill="x", pady=20)

    def create_step_card(self, parent, title, subtitle, buttons, var, placeholder):
        card = ctk.CTkFrame(parent)
        card.pack(fill="x", pady=10)

        ctk.CTkLabel(card, text=title, font=ctk.CTkFont(size=16, weight="bold")).grid(row=0, column=0, padx=15,
                                                                                      pady=(10, 0), sticky="w")
        ctk.CTkLabel(card, text=subtitle, font=ctk.CTkFont(size=12), text_color="gray").grid(row=1, column=0, padx=15,
                                                                                             pady=(0, 10), sticky="w")

        entry_frame = ctk.CTkFrame(card, fg_color="transparent")
        entry_frame.grid(row=2, column=0, sticky="ew", padx=10, pady=5)

        ctk.CTkEntry(entry_frame, textvariable=var, placeholder_text=placeholder, width=500).pack(side="left", padx=5,
                                                                                                  fill="x", expand=True)

        for btn_text, btn_cmd, btn_color in buttons:
            ctk.CTkButton(card, text=btn_text, command=btn_cmd, width=120).grid(row=2,
                                                                                column=1 if "é€‰æ‹©" in btn_text else 2,
                                                                                padx=5, pady=5)

    def create_log_area(self):
        """åº•éƒ¨æ—¥å¿—åŒº - å…³é”®ç‚¹ï¼šè®¾ç½® weight ä½¿å…¶å¯è‡ªç”±ç¼©æ”¾"""
        self.log_frame = ctk.CTkFrame(self)
        self.log_frame.grid(row=1, column=1, sticky="nsew", padx=20, pady=(0, 20))
        self.log_frame.grid_rowconfigure(0, weight=1)
        self.log_frame.grid_columnconfigure(0, weight=1)

        self.log_text = ctk.CTkTextbox(self.log_frame, font=("Consolas", 12), border_width=1)
        self.log_text.grid(row=0, column=0, sticky="nsew", padx=5, pady=5)

        # åˆå§‹æ¬¢è¿è¯­
        self.log(">>> ç³»ç»Ÿå°±ç»ªã€‚ç­‰å¾…æ“ä½œ...", "INFO")

    # --- é€»è¾‘åŠŸèƒ½ (ä¿æŒåŸæœ‰åŠŸèƒ½ï¼Œä¼˜åŒ–æ—¥å¿—è¾“å‡º) ---
    def log(self, message, level="INFO"):
        timestamp = datetime.now().strftime("%H:%M:%S")
        prefix = {"INFO": "ğŸ”µ", "SUCCESS": "âœ…", "ERROR": "âŒ", "WARNING": "âš ï¸"}.get(level, "")
        self.log_text.insert("end", f"[{timestamp}] {prefix} {message}\n")
        self.log_text.see("end")

    def browse_go_file(self):
        file = filedialog.askopenfilename(filetypes=[("Go Files", "*.go")])
        if file:
            self.go_file_path.set(file)
            self.publish_path.set(str(Path(file).parent))
            # è‡ªåŠ¨ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åé€»è¾‘...
            name = Path(file).stem.replace("_v", ".v") + "_arm64"
            self.output_file_name.set(name)
            self.log(f"å·²é€‰æ‹©æºæ–‡ä»¶: {Path(file).name}")

    def browse_deploy_path(self):
        path = filedialog.askdirectory()
        if path:
            self.deploy_path.set(path)

    # ... è¿™é‡Œä¿ç•™ä½ åŸæœ‰çš„ç¼–è¯‘ã€SSHã€éƒ¨ç½²çš„é€»è¾‘ä»£ç  ...
    # æ³¨æ„å°†æ‰€æœ‰çš„ self.log_text.insert æ›¿æ¢ä¸º self.log()
    # å°† messagebox æ›¿æ¢ä¸º ctk çš„æ ·å¼æˆ–ä¿æŒåŸæ ·

    def start_compile(self):
        # ç¤ºä¾‹ï¼šå¤šçº¿ç¨‹æ‰§è¡Œé˜²æ­¢ç•Œé¢å¡æ­»
        threading.Thread(target=self._compile_worker, daemon=True).start()

    def _compile_worker(self):
        self.log("æ­£åœ¨å‡†å¤‡ç¼–è¯‘...", "INFO")
        # æ¨¡æ‹ŸåŸæœ‰ç¼–è¯‘é€»è¾‘...
        # ... åŸæœ‰ä»£ç ä¸­çš„ subprocess è°ƒç”¨ ...
        self.log("ç¼–è¯‘åŠŸèƒ½å·²è°ƒç”¨ (è¯·æ ¹æ®åŸé€»è¾‘è¡¥å……ä»£ç )", "SUCCESS")

    def load_config(self):
        if os.path.exists(CONFIG_FILE):
            try:
                with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                    config = json.load(f)
                    for key, value in config.items():
                        if hasattr(self, key):
                            getattr(self, key).set(value)
            except:
                pass

    def save_config(self):
        config = {
            'ssh_host': self.ssh_host.get(),
            'remote_dir': self.remote_dir.get(),
            'deploy_path': self.deploy_path.get(),
            # ... å…¶ä»–å­—æ®µ ...
        }
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=2)
        self.log("é…ç½®å·²æŒä¹…åŒ–ä¿å­˜", "SUCCESS")

    def clear_log(self):
        self.log_text.delete("1.0", "end")

    def stop_service(self):
        self.log("åœæ­¢æœåŠ¡å‘½ä»¤å·²å‘é€")

    def start_service(self):
        self.log("å¯åŠ¨æœåŠ¡å‘½ä»¤å·²å‘é€")

    def restart_service(self):
        self.log("é‡å¯æœåŠ¡å‘½ä»¤å·²å‘é€")

    def check_status(self):
        self.log("æ­£åœ¨æŸ¥è¯¢è¿›ç¨‹çŠ¶æ€...")

    def local_deploy(self):
        self.log("æ­£åœ¨æ‰§è¡Œæœ¬åœ°æ–‡ä»¶è¦†ç›–...")

    def one_click_all(self):
        self.log("å¼€å§‹å…¨è‡ªåŠ¨æµæ°´çº¿...", "WARNING")


if __name__ == "__main__":
    app = ModernDeployTool()
    app.mainloop()
